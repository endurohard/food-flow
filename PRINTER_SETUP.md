# Настройка системы управления принтерами

## Обзор

Система позволяет настраивать множественные принтеры для разных участков кухни (мучной цех, горячий цех, бар и т.д.).

## Типы чеков

### 1. Кухонный чек (производственная печать)
**Формат:** Упрощенный, только самое необходимое
- Номер заказа (крупный шрифт)
- Время заказа
- Список позиций с количеством
- Комментарии к позициям

**Без:**
- ❌ Адреса доставки
- ❌ Цен
- ❌ Телефонов
- ❌ Итоговых сумм

**Пример:**
```
         #353

        23:10
------------------------

2x
ПИЦЦА 4 СЫРА
>>> без лука

1x
ПИЦЦА ПЕППЕРОНИ

1x
ПИЦЦА БАРБЕКЮ

------------------------
     КОММЕНТАРИЙ:
   сайт оплачен
------------------------
```

### 2. Чек для кассы (клиентский чек)
**Формат:** Полный с ценами и адресом
- Телефон ресторана
- Адрес ресторана
- Номер заказа
- Курьер
- Дата и время
- Позиции с ценами
- Итоговая сумма
- Способ оплаты
- Комментарии
- QR-код для отзывов

## Компоненты

### Backend API (Kitchen Service)

**Доступ только через Kong:** `http://localhost/api/printers`

**Эндпоинты:**
- `GET /api/printers/stations` - Получить все станции
- `POST /api/printers/stations` - Создать станцию
- `PUT /api/printers/stations/:id` - Обновить станцию
- `DELETE /api/printers/stations/:id` - Удалить станцию
- `POST /api/printers/test-station` - Тестовая печать (отправляет реальные ESC/POS команды)
- `GET /api/printers/settings` - Глобальные настройки
- `PUT /api/printers/settings` - Обновить настройки
- `GET /api/printers/stats` - Статистика

### Админ-панель

**Путь:** `/frontend/admin-panel/index.html`

**Возможности:**
- Управление станциями печати
- Настройка категорий блюд для каждой станции
- Тестовая печать с реальной отправкой ESC/POS команд
- Глобальные настройки печати

**URL для доступа:**
```
file:///Users/bagamedovyusup/work/food-flow/frontend/admin-panel/index.html
```

## Архитектура доступа

```
┌─────────────────┐
│  Админ-панель   │
│  (HTML)         │
└────────┬────────┘
         │
         │ HTTP
         ▼
┌─────────────────┐
│  Kong Gateway   │ :80
│  API Proxy      │
└────────┬────────┘
         │
         │ Internal Network
         ▼
┌─────────────────┐
│ Kitchen Service │ (internal only)
│  Printer API    │
└─────────────────┘
         │
         │ ESC/POS via TCP
         ▼
┌─────────────────┐
│   Принтеры      │
│  192.168.x.x    │
└─────────────────┘
```

**Важно:** Все микросервисы недоступны напрямую извне. Весь доступ только через Kong API Gateway на порту 80.

## Настройка принтеров

### Типы принтеров

1. **Сетевой (Network)** - рекомендуется
   - Формат: IP:PORT (например, 192.168.31.87:9100)
   - Порт по умолчанию: 9100
   - Протокол: ESC/POS через TCP

2. **USB**
   - Формат: /dev/usb/lp0
   - Требует доступ к USB в Docker

3. **Bluetooth**
   - Формат: MAC адрес (00:11:22:33:44:55)

### Категории блюд

- `pizza` - Пицца
- `burger` - Бургеры
- `sushi` - Суши
- `drinks` - Напитки
- `dessert` - Десерты
- `hot` - Горячие блюда
- `cold` - Холодные блюда

### Пример конфигурации

```json
{
  "name": "Мучной цех",
  "type": "network",
  "address": "192.168.31.87:9100",
  "categories": ["pizza", "burger"],
  "copies": 1,
  "enabled": true
}
```

## Как использовать

1. Откройте админ-панель в браузере
2. Нажмите "+ Добавить станцию"
3. Заполните данные:
   - Название (например, "Мучной цех")
   - Тип: Сетевой принтер
   - IP адрес: 192.168.31.87:9100
   - Выберите категории (pizza, burger)
   - Количество копий: 1
4. Нажмите "Тест печати" - система отправит реальные ESC/POS команды на принтер
5. Сохраните станцию

## Тестовая печать

При нажатии кнопки "Тест печати" система отправляет на принтер следующие ESC/POS команды:

```
ESC @ - Инициализация принтера
ESC a 1 - Выравнивание по центру
ESC E 1 - Жирный шрифт
GS ! 11 - Двойная высота и ширина
"TEST PRINT"
ESC a 0 - Выравнивание по левому краю
"Принтер: 192.168.31.87:9100"
"Время: [текущее время]"
"Принтер работает!"
GS V 41 03 - Частичная обрезка бумаги
```

Если принтер правильно подключен, он должен напечатать тестовый чек.

## Запуск системы

```bash
cd /Users/bagamedovyusup/work/food-flow
docker-compose up -d
```

Проверка:
```bash
docker-compose ps
curl http://localhost/api/printers/stations
```

## Открытые порты

**Внешние:**
- `80` - Kong Proxy (HTTP API)
- `443` - Kong Proxy (HTTPS API)

**Внутренние (только Docker network):**
- `3001` - User Service
- `3002` - Restaurant Service
- `3003` - Order Service
- `3004` - Delivery Service
- `3005` - Kitchen Service
- `5432` - PostgreSQL
- `6379` - Redis
- `5672/15672` - RabbitMQ

## Troubleshooting

**Принтер не подключается:**
```bash
# Проверка сети
ping 192.168.31.87

# Проверка порта
nc -zv 192.168.31.87 9100
```

**Чек не печатается:**
- Проверьте, что станция включена (enabled: true)
- Убедитесь, что категория блюда назначена на станцию
- Проверьте логи:
  ```bash
  docker-compose logs kitchen-service -f
  ```
- Проверьте доступность принтера с сервера
- Убедитесь, что принтер поддерживает ESC/POS команды

**API не отвечает (502 Bad Gateway):**
- Проблема часто связана с тем, что Kong кэширует DNS после перезапуска сервисов
- Решение: перезапустите Kong:
  ```bash
  docker-compose restart kong
  ```
- Проверьте статус всех сервисов:
  ```bash
  docker-compose ps
  ```

**Порты заняты:**
- Все сервисы работают внутри Docker network
- Наружу открыт только Kong (80, 443)
- Прямой доступ к сервисам невозможен (по дизайну)

**Kitchen Service не отвечает после перезапуска:**
```bash
# Перезапустите Kong для обновления DNS кэша
docker-compose restart kong
```

## ESC/POS Команды

Система использует стандартные ESC/POS команды для термопринтеров:

- `\x1B@` (ESC @) - Инициализация принтера
- `\x1Ba` (ESC a) - Выравнивание текста (0=лево, 1=центр, 2=право)
- `\x1BE` (ESC E) - Жирный шрифт (0=выкл, 1=вкл)
- `\x1D!` (GS !) - Размер текста (0x00=норма, 0x11=2x2)
- `\x1DV\x41\x03` (GS V) - Обрезка бумаги

Эти команды поддерживаются большинством термопринтеров (EPSON, Star, Citizen и др.).
